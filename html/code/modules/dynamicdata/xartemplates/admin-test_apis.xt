<?xml version="1.0" encoding="utf-8"?>
<xar:template xmlns:xar="http://xaraya.com/2004/blocklayout">
    <!-- License: GPL http://www.gnu.org/copyleft/gpl.html -->
    <xar:style scope="module" file="dd"/>
    <xar:template file="admin-mod-head"/>

    <!-- get the list of api objects -->
    <xar:set name="restapiserial">xarModVars::get('dynamicdata','restapi_object_list')</xar:set>
    <xar:if condition="!empty($restapiserial)">
        <xar:set name="restapilist">unserialize($restapiserial)</xar:set>
    <xar:else/>
        <xar:set name="restapilist">array()</xar:set>
    </xar:if>
    <xar:set name="graphqlserial">xarModVars::get('dynamicdata','graphql_object_list')</xar:set>
    <xar:if condition="!empty($graphqlserial)">
        <xar:set name="graphqllist">unserialize($graphqlserial)</xar:set>
    <xar:else/>
        <xar:set name="graphqllist">array()</xar:set>
    </xar:if>

    <!-- define the list of api objects -->
    <xar:set name="dummy">xarVar::fetch('restapi','array',$restapi,array(),xarVar::NOT_REQUIRED)</xar:set>
    <xar:set name="dummy">xarVar::fetch('graphql','array',$graphql,array(),xarVar::NOT_REQUIRED)</xar:set>
    <xar:if condition="!empty($restapi) and !empty($graphql) and xarSec::confirmAuthKey()">
        <xar:set name="restapilist">array_keys($restapi)</xar:set>
        <xar:set name="dummy">xarModVars::set('dynamicdata','restapi_object_list',serialize($restapilist))</xar:set>
        <xar:set name="graphqllist">array_keys($graphql)</xar:set>
        <xar:set name="dummy">xarModVars::set('dynamicdata','graphql_object_list',serialize($graphqllist))</xar:set>
    </xar:if>

    <div class="xar-mod-body">
        <h2>Utilities - Test APIs</h2>
        <xar:template type="module" file="utility-menu"/>
        <fieldset class="xar-form-actions">
            <legend>REST API</legend>
            <div class="xar-row">
                <div class="xar-col">
                    <code>$ composer require --dev nikic/fast-route</code>
                </div>
                <div class="xar-col">
                    Pre-requisite composer package for the REST API endpoint
                </div>
            </div>
            <div class="xar-row">
                <div class="xar-col">
                    <a href="./code/modules/dynamicdata/xartests/swagger-ui.html">Swagger UI</a>
                </div>
                <div class="xar-col">
                    Explore the REST API for Dynamic Data Objects
                </div>
            </div>
            <div class="xar-row">
                <div class="xar-col">
                <xar:if condition="!empty($openapi)">
                    <a href="./var/cache/api/openapi.json">var/cache/api/openapi.json</a>
                <xar:else/>
                    var/cache/api/openapi.json
                </xar:if>
                    &#8635; <a href="#xarController::URL('dynamicdata','admin','test_apis',array('create_rst'=>1))#">re-build</a>
                </div>
                <div class="xar-col">
                    The current openapi.json document for this API
                </div>
            </div>
        </fieldset>
        <fieldset class="xar-form-actions">
            <legend>GraphQL</legend>
            <div class="xar-row">
                <div class="xar-col">
                   <code>$ composer require --dev webonyx/graphql-php</code>
                </div>
                <div class="xar-col">
                    Pre-requisite composer package for the GraphQL interface
                </div>
            </div>
            <div class="xar-row">
                <div class="xar-col">
                    <a href="./code/modules/dynamicdata/xartests/playground.html">GraphQL Playground</a>
                </div>
                <div class="xar-col">
                    Experiment with GraphQL queries and mutations on objects
                </div>
            </div>
            <div class="xar-row">
                <div class="xar-col">
                <xar:if condition="!empty($schema)">
                    <a href="./var/cache/api/schema.graphql">var/cache/api/schema.graphql</a>
                <xar:else/>
                    var/cache/api/schema.graphql
                </xar:if>
                    &#8635; <a href="#xarController::URL('dynamicdata','admin','test_apis',array('create_gql'=>1))#">re-build</a>
                </div>
                <div class="xar-col">
                    The current schema.graphql document for this API
                </div>
            </div>
        </fieldset>
    <!-- show the list of api objects -->
        <form method="post">
            <fieldset class="xar-form-actions">
                <legend>Objects Available via APIs</legend>
                <table class="xar-table xar-items">
                    <thead>
                        <tr>
                            <th>Dynamic Data Object</th>
                            <th>REST API</th>
                            <th>GraphQL</th>
                        </tr>
                    </thead>
                    <tbody>
                    <xar:foreach in="$objects" value="$item">
                        <tr>
                            <td><a href="#xarServer::getObjectURL($item['name'])#">#$item['label']#</a></td>
                            <xar:if condition="empty($restapilist) or in_array($item['name'], $restapilist)">
                                <td><input type="checkbox" name="restapi[#$item['name']#]" id="restapi_#$item['name']#" checked="checked"/></td>
                            <xar:else/>
                                <td><input type="checkbox" name="restapi[#$item['name']#]" id="restapi_#$item['name']#"/></td>
                            </xar:if>
                            <xar:if condition="empty($graphqllist) or in_array($item['name'], $graphqllist)">
                                <td><input type="checkbox" name="graphql[#$item['name']#]" id="graphql_#$item['name']#" checked="checked"/></td>
                            <xar:else/>
                                <td><input type="checkbox" name="graphql[#$item['name']#]" id="graphql_#$item['name']#"/></td>
                            </xar:if>
                        </tr>
                    </xar:foreach>
                    </tbody>
                </table>
                <input type="hidden" name="authid" value="#xarSec::genAuthKey()#"/>
                <xar:var name="label">Update List</xar:var>
                <xar:button type="submit" label="$label"/>
            </fieldset>
        </form>
    </div>
</xar:template>
